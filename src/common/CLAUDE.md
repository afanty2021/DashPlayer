[æ ¹ç›®å½•](../../CLAUDE.md) > [src](../) > **common**

# é€šç”¨æ¨¡å—æ–‡æ¡£

## æ¨¡å—èŒè´£

é€šç”¨æ¨¡å—æä¾›å‰åç«¯å…±äº«çš„ç±»å‹å®šä¹‰ã€å·¥å…·å‡½æ•°ã€API æ¥å£è§„èŒƒå’ŒåŸºç¡€è®¾æ–½ä»£ç ï¼Œç¡®ä¿æ•´ä¸ªåº”ç”¨çš„ç±»å‹å®‰å…¨å’Œä¸€è‡´æ€§ã€‚

## æ¶æ„è®¾è®¡

```mermaid
graph TD
    A["é€šç”¨æ¨¡å—"] --> B["API æ¥å£å®šä¹‰"];
    A --> C["TypeScript ç±»å‹"];
    A --> D["å·¥å…·å‡½æ•°åº“"];
    A --> E["URL å¤„ç†"];
    A --> F["æ–‡æœ¬å¤„ç†"];
    A --> G["é…ç½®ç®¡ç†"];

    B --> H["API ç±»å‹å®‰å…¨"];
    B --> I["è·¯ç”±æ³¨å†Œ"];

    C --> J["ä¸šåŠ¡ç±»å‹å®šä¹‰"];
    C --> K["å­˜å‚¨ç±»å‹"];

    D --> L["å­—ç¬¦ä¸²å·¥å…·"];
    D --> M["æ•°ç»„å·¥å…·"];
    D --> N["æ–‡ä»¶å·¥å…·"];

    E --> O["è‡ªå®šä¹‰åè®®"];
    E --> P["è·¯å¾„è§£æ"];

    F --> Q["å­—å¹•è§£æ"];
    F --> R["æ—¶é—´å¤„ç†"];

    G --> S["åº”ç”¨è®¾ç½®"];
    G --> T["é»˜è®¤é…ç½®"];
```

## API æ¥å£å®šä¹‰

### æ ¸å¿ƒç±»å‹ç³»ç»Ÿ
- **API å®šä¹‰**: `api/api-def.ts` - å®Œæ•´çš„ API ç±»å‹å®šä¹‰
- **API æ˜ å°„**: `api/api-map.ts` - API è·¯ç”±æ˜ å°„å…³ç³»
- **æ³¨å†Œç³»ç»Ÿ**: `api/register.ts` - è·¯ç”±æ³¨å†Œæœºåˆ¶

### ç±»å‹å®‰å…¨çš„ IPC é€šä¿¡
```typescript
// API è°ƒç”¨ç±»å‹å®šä¹‰
export type ApiDefinitions = {
  'system/info': () => Promise<SystemInfo>;
  'media/thumbnail': (params: ThumbnailParams) => Promise<string>;
  'subtitle/parse': (params: SubtitleParams) => Promise<SubtitleResult>;
  // ... æ›´å¤š API å®šä¹‰
};

// è‡ªåŠ¨ç±»å‹æ¨å¯¼
export type ApiMap = {
  [K in keyof ApiDefinitions]: ApiDefinitions[K];
};
```

### è·¯ç”±æ³¨å†Œæœºåˆ¶
- **ç»Ÿä¸€æ³¨å†Œ**: `registerRoute()` å‡½æ•°
- **è‡ªåŠ¨æ—¥å¿—**: æ‰€æœ‰ API è°ƒç”¨è‡ªåŠ¨è®°å½•
- **é”™è¯¯å¤„ç†**: ç»Ÿä¸€çš„å¼‚å¸¸æ•è·å’Œä¼ æ’­
- **ç±»å‹æ¨å¯¼**: TypeScript è‡ªåŠ¨æ¨å¯¼å‚æ•°å’Œè¿”å›ç±»å‹

## TypeScript ç±»å‹ç³»ç»Ÿ

### ä¸šåŠ¡å®ä½“ç±»å‹
- **ChapterResult**: è§†é¢‘ç« èŠ‚è§£æç»“æœ
- **SentenceC**: å¥å­å’Œå­—å¹•ç›¸å…³ç±»å‹
- **Types.ts**: é€šç”¨ç±»å‹å®šä¹‰ (Nullable, WindowState ç­‰)
- **store_schema.ts**: åº”ç”¨é…ç½®å’Œå­˜å‚¨ç±»å‹

### å­˜å‚¨ç±»å‹å®šä¹‰
```typescript
// åº”ç”¨è®¾ç½®é”®å€¼
export type SettingKey =
  | 'appearance.theme'
  | 'ai.openai.api_key'
  | 'translate.youdao.app_key'
  | 'storage.cache_path'
  | // ... æ›´å¤šè®¾ç½®é¡¹

// è®¾ç½®é”®å€¼å¯¹è±¡
export const SettingKeyObj = {
  'appearance.theme': 'appearance.theme',
  'ai.openai.api_key': 'ai.openai.api_key',
  // ...
} as const;
```

### å­—å¹•å’Œæ—¶é—´ç±»å‹
- **æ—¶é—´è½´ç›¸å…³**: å­—å¹•æ—¶é—´æˆ³ã€æ—¶é—´è°ƒæ•´ç±»å‹
- **å­—å¹•å†…å®¹**: å­—å¹•æ–‡æœ¬ã€ç¿»è¯‘ã€æ³¨é‡Šç±»å‹
- **è§†é¢‘ä¿¡æ¯**: è§†é¢‘å…ƒæ•°æ®ã€ç« èŠ‚ä¿¡æ¯ç±»å‹

## å·¥å…·å‡½æ•°åº“

### å­—ç¬¦ä¸²å·¥å…· (`utils/str-util.ts`)
```typescript
class StrUtil {
  static isBlank(str: string): boolean;
  static isNotBlank(str: string): boolean;
  static truncate(str: string, length: number): string;
  static escapeHtml(str: string): string;
  // ... æ›´å¤šå­—ç¬¦ä¸²æ“ä½œ
}
```

### æ•°ç»„å·¥å…· (`utils/array-util.ts`)
```typescript
class ArrayUtil {
  static unique<T>(arr: T[]): T[];
  static groupBy<T, K>(arr: T[], keyFn: (item: T) => K): Map<K, T[]>;
  static chunk<T>(arr: T[], size: number): T[][];
  // ... æ›´å¤šæ•°ç»„æ“ä½œ
}
```

### æ–‡ä»¶å·¥å…· (`utils/file-util.ts`)
```typescript
class FileUtil {
  static getFileExtension(filePath: string): string;
  static getFileName(filePath: string): string;
  static isValidVideoFile(filePath: string): boolean;
  static isValidSubtitleFile(filePath: string): boolean;
  // ... æ›´å¤šæ–‡ä»¶æ“ä½œ
}
```

## URL å¤„ç†ç³»ç»Ÿ

### è‡ªå®šä¹‰åè®® (`utils/UrlUtil.ts`)
```typescript
// DashPlayer è‡ªå®šä¹‰æ–‡ä»¶åè®®
export const DP = 'dp';
export const DP_FILE = 'dp-file';

// åè®®æ³¨å†Œå’Œè§£æ
export function registerFileProtocol(): void;
export function parseDpUrl(url: string): string;
export function createDpUrl(filePath: string): string;
```

### è·¯å¾„å¤„ç†
- **ç›¸å¯¹è·¯å¾„è½¬æ¢**: è·¨å¹³å°è·¯å¾„å¤„ç†
- **URL ç¼–ç **: å®‰å…¨çš„æ–‡ä»¶è·¯å¾„ç¼–ç 
- **åè®®æ”¯æŒ**: æ”¯æŒ dp:// å’Œ dp-file:// åè®®

## æ–‡æœ¬å¤„ç†

### å­—å¹•è§£æ (`utils/srt-parser.ts`)
```typescript
class SrtParser {
  static parse(srtContent: string): SrtEntry[];
  static toString(entries: SrtEntry[]): string;
  static adjustTimestamps(entries: SrtEntry[], offset: number): SrtEntry[];
  // ... æ›´å¤šå­—å¹•å¤„ç†
}
```

### æ—¶é—´å¤„ç† (`utils/time-util.ts`)
```typescript
class TimeUtil {
  static parseSrtTimestamp(timestamp: string): number; // è½¬ä¸ºæ¯«ç§’
  static formatSrtTimestamp(ms: number): string;
  static formatDuration(ms: number): string;
  static addTimeOffset(timestamp: string, offset: number): string;
  // ... æ›´å¤šæ—¶é—´æ“ä½œ
}
```

### æ–‡æœ¬åˆ†æ (`utils/text-util.ts`)
- **å•è¯åˆ†å‰²**: æ™ºèƒ½è‹±æ–‡å•è¯åˆ†å‰²
- **å¥å­åˆ†æ**: å¥å­è¾¹ç•Œæ£€æµ‹
- **è¯­è¨€æ£€æµ‹**: æ–‡æœ¬è¯­è¨€è¯†åˆ«
- **æ¸…ç†å’Œæ ¼å¼åŒ–**: æ–‡æœ¬æ ‡å‡†åŒ–

## é…ç½®ç®¡ç†

### é»˜è®¤é…ç½®
- **åº”ç”¨è®¾ç½®**: é»˜è®¤çš„åº”ç”¨é…ç½®å€¼
- **è·¯å¾„é…ç½®**: é»˜è®¤çš„æ–‡ä»¶è·¯å¾„é…ç½®
- **æœåŠ¡é…ç½®**: å¤–éƒ¨æœåŠ¡çš„é»˜è®¤é…ç½®

### é…ç½®éªŒè¯
- **ç±»å‹æ£€æŸ¥**: é…ç½®å€¼çš„ç±»å‹éªŒè¯
- **èŒƒå›´æ£€æŸ¥**: æ•°å€¼èŒƒå›´éªŒè¯
- **æ ¼å¼éªŒè¯**: è·¯å¾„ã€URL ç­‰æ ¼å¼éªŒè¯

## é”™è¯¯å¤„ç†

### é€šç”¨é”™è¯¯ç±»å‹
- **ä¸šåŠ¡é”™è¯¯**: ç‰¹å®šä¸šåŠ¡åœºæ™¯çš„é”™è¯¯
- **éªŒè¯é”™è¯¯**: æ•°æ®éªŒè¯å¤±è´¥é”™è¯¯
- **ç½‘ç»œé”™è¯¯**: API è°ƒç”¨å¤±è´¥é”™è¯¯
- **æ–‡ä»¶é”™è¯¯**: æ–‡ä»¶æ“ä½œå¤±è´¥é”™è¯¯

### é”™è¯¯ä¼ æ’­æœºåˆ¶
- **ç»Ÿä¸€æ ¼å¼**: æ ‡å‡†åŒ–çš„é”™è¯¯ä¿¡æ¯æ ¼å¼
- **é”™è¯¯é“¾**: é”™è¯¯å †æ ˆè¿½è¸ªå’Œä¼ æ’­
- **ç”¨æˆ·å‹å¥½**: é”™è¯¯ä¿¡æ¯æœ¬åœ°åŒ–å’Œç”¨æˆ·å‹å¥½æç¤º

## å¸¸ç”¨å¸¸é‡

### æ–‡ä»¶ç±»å‹
```typescript
export const VIDEO_EXTENSIONS = ['.mp4', '.mkv', '.avi', '.mov', '.wmv'];
export const SUBTITLE_EXTENSIONS = ['.srt', '.vtt', '.ass'];
export const SUPPORTED_FORMATS = {
  video: VIDEO_EXTENSIONS,
  subtitle: SUBTITLE_EXTENSIONS,
  // ...
};
```

### åº”ç”¨å¸¸é‡
- **ç‰ˆæœ¬ä¿¡æ¯**: åº”ç”¨ç‰ˆæœ¬å’Œæ„å»ºä¿¡æ¯
- **è·¯å¾„å¸¸é‡**: é»˜è®¤è·¯å¾„å’Œç›®å½•ç»“æ„
- **UI å¸¸é‡**: ç•Œé¢ç›¸å…³çš„å¸¸é‡å€¼

## æ€§èƒ½ä¼˜åŒ–

### ç¼“å­˜æœºåˆ¶
- **è§£æç¼“å­˜**: å­—å¹•è§£æç»“æœç¼“å­˜
- **è®¡ç®—ç¼“å­˜**: å¤æ‚è®¡ç®—ç»“æœç¼“å­˜
- **æ–‡ä»¶ç¼“å­˜**: æ–‡ä»¶å†…å®¹ç¼“å­˜

### å†…å­˜ç®¡ç†
- **å¯¹è±¡æ± **: é‡å¤ä½¿ç”¨å¯¹è±¡å‡å°‘ GC å‹åŠ›
- **æµå¼å¤„ç†**: å¤§æ–‡ä»¶æµå¼è¯»å–
- **èµ„æºé‡Šæ”¾**: åŠæ—¶é‡Šæ”¾ä¸éœ€è¦çš„èµ„æº

## æµ‹è¯•æ”¯æŒ

### æµ‹è¯•å·¥å…·
- **Mock å·¥å…·**: API å’Œæ–‡ä»¶ç³»ç»Ÿ Mock
- **æµ‹è¯•æ•°æ®**: æ ‡å‡†æµ‹è¯•æ•°æ®é›†
- **æ–­è¨€å·¥å…·**: è‡ªå®šä¹‰æ–­è¨€å‡½æ•°

### ç±»å‹éªŒè¯
- **è¿è¡Œæ—¶éªŒè¯**: TypeScript ç±»å‹åœ¨è¿è¡Œæ—¶éªŒè¯
- **æ•°æ®ç”Ÿæˆ**: æµ‹è¯•æ•°æ®è‡ªåŠ¨ç”Ÿæˆ
- **è¾¹ç•Œæµ‹è¯•**: è¾¹ç•Œæ¡ä»¶æµ‹è¯•å·¥å…·

## å¸¸è§é—®é¢˜ (FAQ)

### Q: å¦‚ä½•æ‰©å±• API ç±»å‹å®šä¹‰ï¼Ÿ
A: 1. åœ¨ `api/api-def.ts` ä¸­æ·»åŠ æ–°çš„ API å®šä¹‰
   2. åœ¨å¯¹åº”æ§åˆ¶å™¨ä¸­å®ç°å¤„ç†å‡½æ•°
   3. ä½¿ç”¨ `registerRoute()` æ³¨å†Œè·¯ç”±

### Q: å¦‚ä½•æ·»åŠ æ–°çš„å·¥å…·å‡½æ•°ï¼Ÿ
A: 1. åœ¨ `utils/` ç›®å½•åˆ›å»ºå¯¹åº”æ–‡ä»¶
   2. å®ç°é™æ€æ–¹æ³•æˆ–ç‹¬ç«‹å‡½æ•°
   3. æ·»åŠ å®Œæ•´çš„ TypeScript ç±»å‹
   4. ç¼–å†™å•å…ƒæµ‹è¯•

### Q: å¦‚ä½•å¤„ç†ä¸åŒå¹³å°çš„è·¯å¾„é—®é¢˜ï¼Ÿ
A: ä½¿ç”¨ `path` æ¨¡å—å’Œ `UrlUtil.ts` ä¸­çš„å·¥å…·å‡½æ•°ï¼Œç¡®ä¿è·¨å¹³å°å…¼å®¹æ€§

### Q: å¦‚ä½•æ‰©å±•å­—å¹•æ ¼å¼æ”¯æŒï¼Ÿ
A: åœ¨ `utils/` ç›®å½•æ·»åŠ æ–°çš„è§£æå™¨ï¼Œå¹¶åœ¨ `FileUtil.ts` ä¸­æ·»åŠ æ ¼å¼æ£€æµ‹

## ç›¸å…³æ–‡ä»¶æ¸…å•

### ç›®å½•ç»“æ„
```
common/
â”œâ”€â”€ api/                 # API æ¥å£å®šä¹‰
â”‚   â”œâ”€â”€ api-def.ts      # API ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ api-map.ts      # API è·¯ç”±æ˜ å°„
â”‚   â””â”€â”€ register.ts     # è·¯ç”±æ³¨å†Œ
â”œâ”€â”€ types/               # TypeScript ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ Types.ts        # é€šç”¨ç±»å‹
â”‚   â”œâ”€â”€ store_schema.ts # å­˜å‚¨ç±»å‹
â”‚   â”œâ”€â”€ ChapterResult.ts # ç« èŠ‚ç»“æœç±»å‹
â”‚   â””â”€â”€ SentenceC.ts    # å¥å­ç±»å‹
â”œâ”€â”€ utils/               # å·¥å…·å‡½æ•°åº“
â”‚   â”œâ”€â”€ str-util.ts     # å­—ç¬¦ä¸²å·¥å…·
â”‚   â”œâ”€â”€ array-util.ts   # æ•°ç»„å·¥å…·
â”‚   â”œâ”€â”€ file-util.ts    # æ–‡ä»¶å·¥å…·
â”‚   â”œâ”€â”€ time-util.ts    # æ—¶é—´å·¥å…·
â”‚   â”œâ”€â”€ srt-parser.ts   # å­—å¹•è§£æ
â”‚   â””â”€â”€ UrlUtil.ts      # URL å¤„ç†
â””â”€â”€ constants/           # å¸¸é‡å®šä¹‰
```

### å…³é”®æ–‡ä»¶
- `api/api-def.ts` - API ç±»å‹ç³»ç»Ÿæ ¸å¿ƒ
- `types/store_schema.ts` - åº”ç”¨é…ç½®ç±»å‹
- `utils/UrlUtil.ts` - è‡ªå®šä¹‰åè®®å¤„ç†
- `utils/srt-parser.ts` - å­—å¹•è§£ææ ¸å¿ƒ
- `utils/str-util.ts` - å­—ç¬¦ä¸²å¤„ç†å·¥å…·

## æŠ€æœ¯ç‰¹ç‚¹

### ç±»å‹å®‰å…¨
- **ç«¯åˆ°ç«¯ç±»å‹**: ä» API åˆ°ç»„ä»¶çš„å®Œæ•´ç±»å‹å®‰å…¨
- **ç¼–è¯‘æ—¶æ£€æŸ¥**: TypeScript ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥
- **è¿è¡Œæ—¶éªŒè¯**: å…³é”®æ•°æ®çš„è¿è¡Œæ—¶ç±»å‹éªŒè¯

### è·¨å¹³å°å…¼å®¹
- **è·¯å¾„å¤„ç†**: ç»Ÿä¸€çš„è·¨å¹³å°è·¯å¾„å¤„ç†
- **åè®®æ”¯æŒ**: è‡ªå®šä¹‰æ–‡ä»¶åè®®æ”¯æŒ
- **ç¼–ç å¤„ç†**: å¤šè¯­è¨€ç¼–ç æ”¯æŒ

### å¯æ‰©å±•æ€§
- **æ¨¡å—åŒ–è®¾è®¡**: å·¥å…·å‡½æ•°æŒ‰åŠŸèƒ½åˆ†ç±»
- **æ’ä»¶åŒ–**: æ”¯æŒåŠŸèƒ½æ’ä»¶åŒ–æ‰©å±•
- **é…ç½®é©±åŠ¨**: é€šè¿‡é…ç½®æ–‡ä»¶æ§åˆ¶è¡Œä¸º

## å˜æ›´è®°å½• (Changelog)

### 2025-11-20 - é€šç”¨æ¨¡å—æ–‡æ¡£åˆ›å»º
- âœ¨ åˆ›å»ºé€šç”¨æ¨¡å—è¯¦ç»†æ–‡æ¡£
- ğŸ“Š åˆ†æ API ç±»å‹ç³»ç»Ÿå’Œå·¥å…·å‡½æ•°åº“
- ğŸ” è¯†åˆ«å­—å¹•è§£æã€URL å¤„ç†ç­‰æ ¸å¿ƒåŠŸèƒ½
- ğŸ“‹ ç”Ÿæˆæ¨¡å—ä¾èµ–å…³ç³»å›¾
- âš ï¸ å»ºè®®è¡¥å……å·¥å…·å‡½æ•°çš„å•å…ƒæµ‹è¯•

---
*æœ€åæ›´æ–°: 2025-11-20 09:17:47*