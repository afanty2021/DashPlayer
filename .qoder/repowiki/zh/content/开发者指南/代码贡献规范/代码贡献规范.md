# 代码贡献规范

<cite>
**本文档引用的文件**
- [package.json](file://package.json)
- [tsconfig.json](file://tsconfig.json)
- [vite.main.config.ts](file://vite.main.config.ts)
- [vite.base.config.ts](file://vite.base.config.ts)
- [vite.renderer.config.ts](file://vite.renderer.config.ts)
- [forge.config.ts](file://forge.config.ts)
- [src/backend/controllers/AiFuncController.ts](file://src/backend/controllers/AiFuncController.ts)
- [src/backend/services/impl/WhisperServiceImpl.ts](file://src/backend/services/impl/WhisperServiceImpl.ts)
- [src/backend/test/whisper.test.ts](file://src/backend/test/whisper.test.ts)
- [src/common/api/register.ts](file://src/common/api/register.ts)
- [src/backend/ioc/inversify.config.ts](file://src/backend/ioc/inversify.config.ts)
- [src/backend/dispatcher.ts](file://src/backend/dispatcher.ts)
</cite>

## 目录

1. [引言](#引言)
2. [Git 分支管理与提交规范](#git-分支管理与提交规范)
3. [TypeScript 编码与文件组织规范](#typescript-编码与文件组织规范)
4. [功能开发流程](#功能开发流程)
5. [依赖注入规范（InversifyJS）](#依赖注入规范inversifyjs)
6. [单元测试编写指南](#单元测试编写指南)
7. [附录：关键配置文件说明](#附录关键配置文件说明)

## 引言

本规范旨在为 DashPlayer 项目建立统一的代码贡献标准，确保代码质量、可维护性和团队协作效率。通过明确分支策略、编码规范、架构模式和测试实践，所有开发者应遵循一致的开发流程，以保障项目长期健康发展。

## Git 分支管理与提交规范

### 分支命名策略

项目采用基于功能和修复的分支命名前缀，确保分支意图清晰可辨：

- **功能开发**：使用 `feature/` 前缀，例如 `feature/audio-enhancement`
- **缺陷修复**：使用 `fix/` 前缀，例如 `fix/subtitle-sync-bug`
- **重构**：使用 `refactor/` 前缀，例如 `refactor/whisper-service`
- **发布准备**：使用 `release/vX.X.X` 格式，例如 `release/v5.2.0`

所有分支应从 `main` 分支创建，并在功能完成后通过 Pull Request 合并回 `main`。

### 提交信息格式

提交信息应遵循 **Conventional Commits** 规范，格式如下：

```
<type>(<scope>): <subject>
<BLANK LINE>
<body>
<BLANK LINE>
<footer>
```

- **type**：提交类型，如 `feat`（新功能）、`fix`（修复）、`docs`（文档）、`style`（格式）、`refactor`（重构）、`test`（测试）、`chore`（构建）
- **scope**：影响范围，如 `ai`, `subtitle`, `storage`
- **subject**：简短描述（不超过 50 字符）

示例：
```
feat(ai): 添加语音转文字功能
fix(subtitle): 修复字幕时间轴偏移问题
refactor(service): 重构 Whisper 服务依赖注入
```

**Section sources**
- [package.json](file://package.json#L5-L10)

## TypeScript 编码与文件组织规范

### 编码规范

项目使用 ESLint 进行代码质量控制，核心规则包括：

- 启用 `strict` 模式（`tsconfig.json` 中配置）
- 使用装饰器元数据（`experimentalDecorators`, `emitDecoratorMetadata`）
- 强类型检查（`noImplicitAny`）
- 使用 `@types` 包进行类型定义管理
- 遵循 `@typescript-eslint` 推荐规则集

所有代码必须通过 `yarn lint` 检查后方可提交。

### 文件命名与目录结构

#### 文件命名

- 使用 **小写加连字符** 命名文件，如 `ai-trans-controller.ts`
- 测试文件以 `.test.ts` 结尾，如 `whisper.test.ts`
- 类型定义文件以 `.d.ts` 结尾，如 `types.d.ts`

#### 目录结构原则

项目遵循分层架构设计：

```
src/
├── backend/           # 后端逻辑
│   ├── controllers/   # 控制器层
│   ├── services/      # 服务层
│   ├── db/            # 数据访问层
│   └── ioc/           # 依赖注入配置
├── common/            # 共享类型与工具
│   ├── api/           # API 定义
│   └── types/         # 类型定义
└── frontend/          # 前端组件
```

**Section sources**
- [tsconfig.json](file://tsconfig.json#L2-L25)
- [vite.main.config.ts](file://vite.main.config.ts#L1-L38)
- [vite.renderer.config.ts](file://vite.renderer.config.ts#L1-L29)

## 功能开发流程

### 添加新功能的步骤

1. **创建分支**：`git checkout -b feature/new-feature`
2. **定义 API 路由**：在 `src/common/api/register.ts` 中注册新路由
3. **实现 Controller**：在 `src/backend/controllers/` 下创建控制器类
4. **实现 Service**：在 `src/backend/services/` 下实现业务逻辑
5. **编写单元测试**：在 `src/backend/test/` 下添加测试用例
6. **提交 PR**：推送分支并创建 Pull Request

### API 路由注册

所有 API 路由通过 `registerRoute` 函数统一注册。示例如下：

```ts
registerRoute('/api/ai/transcribe', AiTransController, 'transcribe');
```

该机制由 `dispatcher.ts` 实现，支持基于装饰器的路由映射。

**Section sources**
- [src/common/api/register.ts](file://src/common/api/register.ts#L1-L50)
- [src/backend/dispatcher.ts](file://src/backend/dispatcher.ts#L1-L100)

## 依赖注入规范（InversifyJS）

### 正确使用方式

项目使用 InversifyJS 实现依赖注入，关键要点如下：

- 所有服务类必须使用 `@injectable()` 装饰器
- 构造函数参数使用 `@inject(SERVICE_IDENTIFIER)` 注入依赖
- 服务标识符定义在 `src/backend/ioc/types.ts`
- 容器配置在 `src/backend/ioc/inversify.config.ts` 中完成

### 示例代码

```ts
@injectable()
class AiTransController implements IController {
    constructor(
        @inject(AiTransService) private aiTransService: IAiTransService
    ) {}
}
```

避免直接实例化服务，始终通过 DI 容器获取依赖，以保证单例模式和可测试性。

**Section sources**
- [src/backend/ioc/inversify.config.ts](file://src/backend/ioc/inversify.config.ts#L1-L30)
- [src/backend/ioc/types.ts](file://src/backend/ioc/types.ts#L1-L20)

## 单元测试编写指南

### 测试结构

单元测试文件位于 `src/backend/test/` 目录下，遵循以下结构：

- 每个服务对应一个测试文件（如 `whisper.test.ts`）
- 使用 `vitest` 作为测试框架
- 测试用例应覆盖正常路径、异常路径和边界条件

### 测试服务层逻辑

测试服务层时，应：

- 使用 `inversify` 容器获取服务实例
- 模拟外部依赖（如数据库、HTTP 客户端）
- 验证业务逻辑正确性

### 模拟外部依赖

使用 `vitest` 的 `vi.mock()` 功能模拟外部依赖。示例如下：

```ts
vi.mock('axios', () => ({
    default: {
        post: vi.fn().mockResolvedValue({ data: 'mocked response' })
    }
}));
```

### 测试示例参考

参考 `whisper.test.ts` 文件中的测试用例，学习如何：

- 设置测试上下文
- 模拟 `Whisper` API 调用
- 验证音频转录结果
- 测试错误处理逻辑

**Section sources**
- [src/backend/test/whisper.test.ts](file://src/backend/test/whisper.test.ts#L1-L100)
- [package.json](file://package.json#L10-L15)

## 附录：关键配置文件说明

### 构建与打包配置

| 文件 | 用途 |
|------|------|
| `forge.config.ts` | Electron Forge 配置，定义打包目标（Squirrel、DMG、RPM、Deb） |
| `vite.main.config.ts` | 主进程 Vite 构建配置 |
| `vite.renderer.config.ts` | 渲染进程构建配置 |
| `vite.base.config.ts` | 共享构建配置，包含热重载插件 |

### 开发脚本

`package.json` 中定义了以下关键脚本：

- `yarn start`：启动开发服务器（自动下载资源）
- `yarn make`：打包应用程序
- `yarn lint`：执行代码检查
- `yarn test`：运行单元测试

**Section sources**
- [forge.config.ts](file://forge.config.ts#L1-L92)
- [package.json](file://package.json#L5-L15)